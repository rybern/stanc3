(library
  (name frontend)
  (libraries core_kernel re menhirLib fmt middle analysis_and_optimization)
  (inline_tests)
  (preprocess (pps ppx_jane ppx_deriving.fold ppx_deriving.map)))

(ocamllex lexer)

(rule
 (targets parsing_errors.ml)
 (deps parser.mly parser.messages)
 (action
  (with-stdout-to %{targets}
   (run menhir
    --explain
    --strict
    --unused-tokens parser.mly --compile-errors parser.messages))))

(menhir
 (modules parser)
 (flags :standard --table --strict --unused-tokens --fixed-exception))

(rule
 (with-stdout-to parser_updated.messages
  (run menhir %{dep:parser.mly} --update-errors %{dep:parser.messages})))

(rule
 (with-stdout-to parser_updated_trimmed.messages
  (run python3 %{dep:strip_redundant_parser_state.py} %{dep:parser_updated.messages})))

(rule
 (targets parser_new.messages)
 (action
   (with-stdout-to %{targets} (run menhir --list-errors %{dep:parser.mly}))))

(alias
 (name dedup_messages)
 (action
  (progn
   (run python3 %{dep:message_deduplicating_tool.py} %{dep:parser_new.messages} parser.messages.dune_dedup))))

(alias
 (name update_messages)
 (action
  (progn
   (run python3 %{dep:add_missing_messages.py} %{dep:parser.mly} %{dep:parser_new.messages} %{dep:parser_updated_trimmed.messages})
   (diff %{dep:parser.messages} %{dep:parser_updated_trimmed.messages}))))

; make a new rule for dedup with new.messages
; overall: talk about your design decisions, including parsing with the .1 syntax, and tag the appropriate people
(alias
 (name runtest)
 (action
  (run menhir parser.mly --compare-errors %{dep:parser_new.messages} --compare-errors %{dep:parser.messages})))
